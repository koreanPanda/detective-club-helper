<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Detective Club Helper</title>
  <style>
    :root { --pad: 18px; --radius: 16px; --shadow: 0 10px 30px rgba(0,0,0,.08); }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: #f6f7fb;
      color: #111;
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }
    .app { width: min(620px, 100%); padding: var(--pad); padding-bottom: calc(var(--pad) + env(safe-area-inset-bottom)); }
    .card { background:#fff; border-radius:var(--radius); box-shadow:var(--shadow); padding:var(--pad); margin:10px 0; }
    h1 { font-size: 22px; margin: 0 0 8px; }
    h2 { font-size: 18px; margin: 0 0 8px; }
    p { margin: 8px 0; line-height: 1.45; color: #333; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    label { font-size: 13px; color: #444; display: block; margin: 12px 0 6px; }
    input, select, textarea {
      width: 100%;
      padding: 12px 12px;
      border: 1px solid #d8dbe6;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      background: #fff;
      color:#111;
    }
    input:focus, select:focus, textarea:focus { border-color:#7aa7ff; box-shadow:0 0 0 3px rgba(122,167,255,.25); }
    .btn {
      width: 100%;
      padding: 14px 14px;
      border: 0;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 800;
      background: #111;
      color: #fff;
      cursor: pointer;
      margin-top: 12px;
    }
    .btn.secondary { background:#e9ecf6; color:#111; }
    .btn.danger { background:#d62828; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn:active { transform: translateY(1px); }
    .muted { color:#666; font-size: 13px; }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius:999px;
      background:#f0f2f9; color:#222; font-size:13px; font-weight:700;
    }
    .divider { height:1px; background:#eef0f6; margin:14px 0; }
    .big { font-size: 22px; font-weight: 900; line-height: 1.25; margin: 6px 0 10px; }
    .center { text-align:center; }
    .progressWrap { height: 10px; background:#eef0f6; border-radius:999px; overflow:hidden; }
    .progressBar { height: 10px; width: 0%; background:#111; transition: width 0.05s linear; }
    .pressArea{
      user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
      touch-action: manipulation;
      border:2px dashed #d8dbe6;
      border-radius:18px;
      padding:18px;
      margin-top:12px;
      background:#fbfcff;
    }
    .revealBox{
      border-radius:18px;
      padding:18px;
      background:#111;
      color:#fff;
      margin-top:12px;
      min-height:86px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-size:18px;
      font-weight:900;
      opacity:.10;
    }
    table { width:100%; border-collapse:collapse; }
    th, td { padding: 10px 6px; border-bottom: 1px solid #eef0f6; text-align:left; }
    th { font-size: 13px; color:#666; }
    td { font-size: 15px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 420px) { .grid2 { grid-template-columns: 1fr; } }
    .notice{
      font-size: 12px; color:#666; margin-top:10px;
      background:#f5f7ff; border:1px solid #e1e7ff;
      padding:10px 12px; border-radius:12px;
    }

    /* Player highlight */
    .pmark{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 900;
      color:#111;
      background: var(--bg, #f0f2f9);
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      white-space: nowrap;
    }
    .dot{
      width: 10px; height: 10px; border-radius:999px;
      background: var(--c, #111);
      box-shadow: 0 2px 6px rgba(0,0,0,.12);
      flex: 0 0 auto;
    }
    .pno { font-weight: 800; color:#333; opacity:.75; font-size: 12px; }

    /* Name entry default behavior */
    .nameInput.defaultName {
      color: #9aa0ad;
      font-weight: 800;
    }
    .nameInput.realName {
      color: #111;
      font-weight: 900;
    }

    /* Colored small token for "1번" etc in name list */
    .numToken{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:72px;
      height: 40px;
      padding: 0 12px;
      border-radius: 999px;
      font-weight: 900;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      background: var(--bg, #f0f2f9);
      color:#111;
      gap:8px;
      flex: 0 0 auto;
    }
    .numToken .dot{
      width: 10px; height: 10px; border-radius:999px;
      background: var(--c, #111);
      box-shadow: 0 2px 6px rgba(0,0,0,.12);
    }

    /* Voting tokens UI */
    .tiles { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; margin-top:12px; }
    @media (max-width: 420px) { .tiles { grid-template-columns: 1fr; } }
    .tile{
      border:1px solid #e7eaf4;
      border-radius:16px;
      padding:14px;
      background:#fff;
      box-shadow: 0 6px 18px rgba(0,0,0,.05);
      cursor:pointer;
      user-select:none;
      position:relative;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
    }
    .tileTitle { font-weight:900; font-size:16px; margin:0; }
    .tileSub { font-size:12px; color:#666; margin-top:4px; }
    .tokenStack { display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; align-items:center; }
    .token{
      width: 12px; height: 12px; border-radius:999px;
      background: var(--c, #111);
      box-shadow: 0 2px 6px rgba(0,0,0,.18);
    }
    .badge{
      position:absolute; top:10px; right:10px;
      background:#f0f2f9; border:1px solid #e2e6f2;
      padding:6px 8px; border-radius:999px; font-weight:900; font-size:12px;
    }
    .chipRow { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; justify-content:center; }
    .chip{
      background:#f0f2f9; border:1px solid #e2e6f2;
      padding:7px 10px; border-radius:999px; font-size:13px; font-weight:800;
      cursor:pointer;
      user-select:none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
    }

    /* Disabled target tile */
    .tile.disabled{
      opacity: .45;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* Hold-to-vote bar (0.5s) */
    .tileHoldBarWrap{
      height: 8px;
      background:#eef0f6;
      border-radius:999px;
      overflow:hidden;
      margin-top:10px;
    }
    .tileHoldBar{
      height: 8px;
      width: 0%;
      background:#111;
      transition: width 0.05s linear;
    }
    .tileHoldHint{
      font-size: 12px;
      color:#666;
      margin-top:8px;
      text-align:center;
    }

    /* Wobble + Pop for vote tiles */
    @keyframes wobble {
      0%   { transform: translateX(0) rotate(0deg); }
      15%  { transform: translateX(-1px) rotate(-0.6deg); }
      30%  { transform: translateX(1px) rotate(0.6deg); }
      45%  { transform: translateX(-1px) rotate(-0.6deg); }
      60%  { transform: translateX(1px) rotate(0.6deg); }
      75%  { transform: translateX(-0.5px) rotate(-0.3deg); }
      100% { transform: translateX(0) rotate(0deg); }
    }
    @keyframes pop {
      0%   { transform: scale(1); }
      50%  { transform: scale(0.97); }
      100% { transform: scale(1.02); }
    }

    /* Selected tile keeps wobbling until confirmed */
    .tile.selected{
      animation: wobble 140ms linear infinite;
      border-color: rgba(0,0,0,.20);
      box-shadow: 0 10px 24px rgba(0,0,0,.12);
    }
    .tile.popping{
      animation: pop 120ms ease-out 1;
    }

    /* iOS long-press menu / text selection hard block */
    html, body {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    /* allow typing/selecting in inputs */
    input, textarea, select {
      -webkit-user-select: text !important;
      user-select: text !important;
      -webkit-touch-callout: default !important;
    }
    /* strongest block on interactive areas */
    .pressArea, .tile, .chip, .chipRow, .tiles, .revealBox, .progressWrap {
      -webkit-user-select: none !important;
      user-select: none !important;
      -webkit-touch-callout: none !important;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
  </style>
</head>
<body>
  <div class="app" id="app"></div>

<script>
(() => {
  const STORAGE_KEY = "dc_helper_v7_full";

  const PASTELS = [
    "#FFD6A5", "#FDFFB6", "#CAFFBF", "#9BF6FF", "#A0C4FF",
    "#BDB2FF", "#FFC6FF", "#FFADAD", "#CDEAC0", "#B9FBC0",
    "#D0F4DE", "#FDE2E4", "#E2F0CB", "#CFBAF0", "#F1C0E8",
    "#F9F9C5", "#BEE1E6", "#EAC4D5", "#C6DEF1", "#F2C6DE"
  ];

  const defaultState = {
    N: 6,
    totalRounds: 0,
    round: 1,
    phase: "HOME",
    players: [],         // {id, name, score, color, isDefaultName}
    hostId: 1,
    liarId: null,
    keyword: "",
    revealOrder: [],
    cursor: 0,
    revealed: {},
    voteOrder: [],
    voteCursor: 0,
    votes: {},
    accusations: {},
    _lastAccusationCount: 0,

    // vote UX
    voteSelectedTarget: null,
    _voteCursorSeen: -1,
  };

  let state = load() || initDefault();

  function initDefault() {
    const s = structuredClone(defaultState);
    s.players = [];
    for (let i = 1; i <= s.N; i++) {
      s.players.push({
        id: i,
        name: `Player ${i}`,
        score: 0,
        color: colorForId(i),
        isDefaultName: true
      });
    }
    s.hostId = 1;
    return s;
  }

  function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function load() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);

      // Backfill
      if (obj?.players?.length) {
        obj.players = obj.players.map(p => ({
          ...p,
          color: p.color || colorForId(p.id),
          isDefaultName: (typeof p.isDefaultName === "boolean") ? p.isDefaultName : isLooksLikeDefault(p.name, p.id),
        }));
      }
      if (typeof obj.voteSelectedTarget === "undefined") obj.voteSelectedTarget = null;
      if (typeof obj._voteCursorSeen === "undefined") obj._voteCursorSeen = -1;

      return obj;
    } catch { return null; }
  }

  function resetAll() {
    state = initDefault();
    state.phase = "HOME";
    save();
    render();
  }

  // back navigation guard
  history.pushState({locked:true}, "");
  window.addEventListener("popstate", () => {
    history.pushState({locked:true}, "");
    toast("뒤로가기는 비활성화되어 있어요. (치팅 방지)");
  });

  const $app = document.getElementById("app");

  function setPhase(phase) { state.phase = phase; save(); render(); }

  function clampInt(v, min, max, fallback) {
    const n = parseInt(v, 10);
    if (Number.isNaN(n)) return fallback;
    return Math.min(max, Math.max(min, n));
  }

  function colorForId(id) { return PASTELS[(id - 1) % PASTELS.length]; }

  function hexToRgba(hex, a) {
    const h = (hex || "").replace("#", "");
    const v = h.length === 3 ? h.split("").map(ch => ch + ch).join("") : h;
    const r = parseInt(v.slice(0,2), 16);
    const g = parseInt(v.slice(2,4), 16);
    const b = parseInt(v.slice(4,6), 16);
    return `rgba(${r}, ${g}, ${b}, ${a})`;
  }

  function playerById(id) { return state.players.find(p => p.id === id); }
  function pcolor(id) { return playerById(id)?.color || colorForId(id); }

  function pmarkHTML(id, withNo=true) {
    const p = playerById(id);
    const name = p?.name ?? `${id}번`;
    const c = pcolor(id);
    const bg = hexToRgba(c, 0.28);
    return `
      <span class="pmark" style="--c:${c};--bg:${bg}">
        <span class="dot" style="--c:${c}"></span>
        <span>${escapeHtml(name)}</span>
        ${withNo ? `<span class="pno">${id}번</span>` : ``}
      </span>
    `;
  }

  function numTokenHTML(id) {
    const c = pcolor(id);
    const bg = hexToRgba(c, 0.28);
    return `
      <div class="numToken" style="--c:${c};--bg:${bg}">
        <span class="dot" style="--c:${c}"></span>
        <span>${id}번</span>
      </div>
    `;
  }

  function makeOrderExcluding(N, excludeId) {
    const arr = [];
    for (let i=1; i<=N; i++) if (i !== excludeId) arr.push(i);
    return arr;
  }
  function nextHostId(host, N) { return (host % N) + 1; }
  function pickRandom(arr) { return arr?.length ? arr[Math.floor(Math.random() * arr.length)] : null; }

  function startRound() {
    state.keyword = (state.keyword || "").trim();
    state.revealOrder = makeOrderExcluding(state.N, state.hostId);
    state.cursor = 0;
    state.revealed = {};
    state.votes = {};
    state.accusations = {};
    state.voteOrder = [];
    state.voteCursor = 0;
    state.voteSelectedTarget = null;
    state._voteCursorSeen = -1;

    state.liarId = pickRandom(state.revealOrder);

    save();
    setPhase("REVEAL");
  }

  function finishReveal() { setPhase("PLAY_START"); }

  function startVoting() {
    state.voteOrder = makeOrderExcluding(state.N, state.hostId);
    state.voteCursor = 0;
    state.votes = {};
    state.accusations = {};
    state.voteSelectedTarget = null;
    state._voteCursorSeen = -1;
    save();
    setPhase("VOTING_TOKENS");
  }

  function rebuildAccusationsFromVotes() {
    const acc = {};
    for (const [voterStr, targetId] of Object.entries(state.votes)) {
      const tid = parseInt(targetId, 10);
      acc[tid] = (acc[tid] || 0) + 1;
    }
    state.accusations = acc;
  }

  function registerVote(voterId, targetId) {
    state.votes[voterId] = targetId;
    rebuildAccusationsFromVotes();
  }

  function applyScoring() {
    const hostId = state.hostId;
    const liarId = state.liarId;
    const accusationCount = state.accusations[liarId] || 0;

    for (const voterIdStr of Object.keys(state.votes)) {
      const voterId = parseInt(voterIdStr, 10);
      if (voterId === hostId) continue;
      if (parseInt(state.votes[voterId], 10) === liarId) {
        const p = playerById(voterId);
        if (p) p.score += 3;
      }
    }

    if (accusationCount <= 1) {
      const liar = playerById(liarId);
      const host = playerById(hostId);
      if (liar) liar.score += 5;
      if (host) host.score += 4;
    }

    state._lastAccusationCount = accusationCount;
    save();
  }

  function finishVoting() {
    applyScoring();
    setPhase("RESULT");
  }

  function nextRound() {
    state.round += 1;
    state.hostId = nextHost
